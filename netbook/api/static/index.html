<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>网文推荐</title>
</head>

<style type="text/css">
    .search-bar {
        margin-top: 20%;
    }

    .book-recommend {
        margin-top: 2.5%;
    }

    .twitter-typeahead {
        float: left;
        width: 100%
    }

    .tt-input, /* UPDATE: newer versions use tt-input instead of tt-query */
    .tt-hint {
        width: 396px;
        height: 30px;
        padding: 8px 12px;
        font-size: 28px;
        line-height: 30px;
        border: 2px solid #ccc;
        border-radius: 8px;
        outline: none;
    }

    .tt-input { /* UPDATE: newer versions use tt-input instead of tt-query */
        box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
    }

    .tt-hint {
        color: #999;
    }

    .tt-menu { /* UPDATE: newer versions use tt-menu instead of tt-dropdown-menu */
        /*width: 422px;*/
        width: 100%;
        margin-top: 12px;
        padding: 8px 0;
        background-color: #fff;
        border: 1px solid #ccc;
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        overflow-y: auto;
        max-height: 250px;
        box-shadow: 0 5px 10px rgba(0, 0, 0, .2);
    }

    .tt-suggestion {
        padding: 3px 20px;
        font-size: 18px;
        line-height: 24px;
    }

    .tt-suggestion.tt-is-under-cursor { /* UPDATE: newer versions use .tt-suggestion.tt-cursor */
        color: #fff;
        background-color: #0097cf;

    }

    .tt-suggestion p {
        margin: 0;
    }

    .tt-dropdown-menu .tt-suggestion,
    .tt-menu .tt-suggestion {
        display: block;
        padding: 3px 20px;
        clear: both;
        font-weight: normal;
        line-height: 1.42857143;
        color: #333333;
    }

    .tt-dropdown-menu .tt-suggestion.tt-cursor,
    .tt-menu .tt-suggestion.tt-cursor,
    .tt-dropdown-menu .tt-suggestion:hover,
    .tt-menu .tt-suggestion:hover {
        cursor: pointer;
        text-decoration: none;
        outline: 0;
        background-color: #f5f5f5;
        color: #262626;
    }

    .tt-dropdown-menu .tt-suggestion.tt-cursor a,
    .tt-menu .tt-suggestion.tt-cursor a,
    .tt-dropdown-menu .tt-suggestion:hover a,
    .tt-menu .tt-suggestion:hover a {
        color: #262626;
    }

    .tt-dropdown-menu .tt-suggestion p,
    .tt-menu .tt-suggestion p {
        margin: 0;
    }


</style>
<body>

<div class="container" id="app">
    <div class="row search-bar">
        <div class="col-md-8 search-input col-md-offset-2 col-sm-12">
            <div class="form-group">
                <div class="input-group">
                    <input type="text"
                           class="form-control typeahead"
                           v-model="key"
                           placeholder="请输入书籍名， 例如 美女图"
                           @keypress="enterSearch"
                    >
                    <span class="input-group-btn">
                        <button
                                type="button"
                                class="btn btn-primary"
                                @click="searchBooks">
                            推荐类似书籍
                        </button>
                    </span>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-10 col-md-offset-1 col-sm-12 book-recommend">
            <table class="table table-bordered">
                <thead>
                <tr>
                    <td>书名</td>
                    <td>作者</td>
                    <td>字数</td>
                    <td>相似度</td>
                </tr>
                </thead>
                <tr is='book-row' v-for="book in books" :book="book">
                </tr>
            </table>
        </div>
    </div>
</div>

<!-- 新 Bootstrap 核心 CSS 文件 -->
<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css">

<!-- 可选的Bootstrap主题文件（一般不用引入） -->
<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap-theme.min.css">
<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput-typeahead.css">-->
<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
<!--<script netbook="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>-->
<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>


<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="http://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="//cdn.bootcss.com/vue/1.0.26/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/typeahead.js/0.11.1/typeahead.bundle.min.js"></script>
</body>
<script type="text/javascript">
    var v = new Vue({
        el: '#app',
        data: {
            books: [],
            suggestions: [],
            key: ""
        },

        ready: function () {
            var engine = new Bloodhound({
                remote: {
                    url: '/api/netbook/suggestion?key=%QUERY',
                    wildcard: '%QUERY',
                    filter: function (response) {
                        return response.suggestions
                    }
                },             // 远程数据源
                datumTokenizer: Bloodhound.tokenizers.obj.whitespace('book_name'),
                queryTokenizer: Bloodhound.tokenizers.whitespace
            });
            engine.initialize();

            $('.typeahead')
                    .typeahead({
                                minLength: 1,
                                highlight: true,
                                hint: true
                            },
                            {
                                name: 'book_infos',
                                source: engine.ttAdapter(),
                                limit: Infinity,
                                displayKey: 'book_name',
                            })
                    .on('typeahead:select', function (e, suggestion) {
                        this.key = suggestion.book_name;
                    }.bind(this));

        },

        methods: {
            enterSearch: function (e) {
                if (!this.isKeyValid()) {
                    return
                }
                if (e.keyCode === 13) {
                    this.searchBooks()
                }
            },
            keyupSuggestion: function () {
                if (this.isKeyNull()) {
                    return
                }

                this.suggestion()
            },
            isKeyValid: function () {
                return !(this.key === "" || this.key === localStorage.key);

            },
            isKeyNull: function () {
                return (this.key === "");
            },
            searchBooks: function () {
                if (!this.isKeyValid()) {
                    return
                }
                $.getJSON('/api/netbook/recommend?key=' + v.$data.key + '&model=tfidf', function (data) {
                    v.$data.books = JSON.parse(JSON.stringify(data.similarity_books));
                    localStorage.key = v.$data.key
                }).fail(function () {
                    alert(v.$data.key + " 未找到相应书籍，请尝试其他书籍")
                })
            },
            suggestion: function () {
                $.getJSON('/api/netbook/suggestion?key=' + this.key, function (data) {
                    console.log(v.$data.key);
                    this.suggesions = JSON.parse(JSON.stringify(data.suggestions));
                    v.$data.suggestions = this.suggesions

                }).fail(function () {
                    console.log("fail to load suggestion.")
                })
            },
        },
        components: {
            'book-row': {
                template: '<tr>' +
                '<td>{{book.book_name}}</td>' +
                '<td>{{book.book_author}}</td>' +
                '<td>{{book.book_words}}</td>' +
                '<td>{{ toPercent(book.rate) }}</td>' +
                '</tr>',
                props: ['book'],
                methods: {
                    toPercent: function (rate) {
                        return Math.round(rate * 100) + '%'
                    }
                }
            }
        }
    })
</script>
</html>